<process name="Blue Prism - Remote Desktop Services" version="1.0" bpversion="6.3.0.6190" narrative="" byrefcollection="true" type="object" runmode="Background" preferredid="14c7a564-353a-4786-9a82-aa0f2217f848">
  <appdef>
    <element name="Application Root">
      <id>a4239f52-92e5-4535-a9ba-d58a40fa7679</id>
      <type>Application</type>
      <basetype>Application</basetype>
      <datatype>unknown</datatype>
      <diagnose>False</diagnose>
    </element>
  </appdef>
  <view>
    <camerax>0</camerax>
    <cameray>0</cameray>
    <zoom version="2">1.25</zoom>
  </view>
  <preconditions />
  <endpoint narrative="" />
  <subsheet subsheetid="6925cf35-a8fb-41fd-a708-570a874ba7e4" type="CleanUp" published="True">
    <name>Clean Up</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="3dfd8390-706e-4cb2-b733-7adf34137125" type="Normal" published="True">
    <name>Get Current Session ID</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="af7ce39a-c800-4bc3-bcad-e4e9965c38c9" type="Normal" published="True">
    <name>Get Logged In Users</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="6f776231-7e10-407d-b84f-ccfda1f6a4c1" type="Normal" published="False">
    <name>Kill RDP Session</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="89646c06-55db-4863-b113-7672c59dc6bf" type="Normal" published="True">
    <name>Log Off Current</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="46504710-b6e6-4f80-826b-6c3e89cb51b2" type="Normal" published="True">
    <name>Log Off User</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="8f61dacb-0685-41de-915d-001befb4b1d0" type="Normal" published="True">
    <name>Start RDP Session</name>
    <view>
      <camerax>0</camerax>
      <cameray>21</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <subsheet subsheetid="c659182c-0795-4ab1-8a96-9f17507a2276" type="Normal" published="True">
    <name>Launch With PID</name>
    <view>
      <camerax>0</camerax>
      <cameray>0</cameray>
      <zoom version="2">1.25</zoom>
    </view>
  </subsheet>
  <stage stageid="84193966-30ad-4835-b996-7ec2cdb40972" name="Start" type="Start">
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>f5b667dd-1d9b-461d-aa16-90a51b193e22</onsuccess>
  </stage>
  <stage stageid="f5b667dd-1d9b-461d-aa16-90a51b193e22" name="End" type="End">
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>90</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="40c48408-111d-4913-b5f9-0e0c34238870" name="Stage1" type="ProcessInfo">
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <references>
      <reference>System.dll</reference>
      <reference>System.Data.dll</reference>
      <reference>System.Xml.dll</reference>
      <reference>System.Drawing.dll</reference>
      <reference>System.Core.dll</reference>
    </references>
    <imports>
      <import>System</import>
      <import>System.Drawing</import>
      <import>System.Data</import>
      <import>System.Diagnostics</import>
      <import>System.Threading</import>
      <import>System.Runtime.InteropServices</import>
      <import>System.Text.RegularExpressions</import>
      <import>System.IO</import>
      <import>System.ComponentModel</import>
    </imports>
    <language>csharp</language>
    <globalcode><![CDATA[]]></globalcode>
    <code><![CDATA[[DllImport("kernel32.dll", SetLastError = true)]
static extern int Wow64DisableWow64FsRedirection(ref IntPtr ptr);
[DllImport("kernel32.dll", SetLastError = true)]
static extern int Wow64EnableWow64FsRedirection(ref IntPtr ptr);
[DllImport("wtsapi32.dll")]
static extern IntPtr WTSOpenServer([MarshalAs(UnmanagedType.LPStr)] String pServerName);
[DllImport("wtsapi32.dll")]
static extern void WTSCloseServer(IntPtr hServer);
[DllImport("wtsapi32.dll")]
static extern bool WTSLogoffSession(IntPtr hServer, int SessionId, bool bWait);
[DllImport("user32.dll",EntryPoint = "ShowWindow",SetLastError = true)]
static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);

private string queryUserRegEx = @"\W*(?<username>\w+)\s+[-#a-z0-9]+\s+(?<session>\d+)\s+(?<state>\w+)\s+.*";

void CreateCredential(string username, string password)
{
	Process addKeyProcess = new Process();
	addKeyProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\cmdkey.exe");
	addKeyProcess.StartInfo.Arguments = "/generic:TERMSRV/localhost /user:" + username +  " /pass:" + password;
	addKeyProcess.Start();
}

bool CheckCredential(string username)
{
	Process checkKeyProcess = new Process();
	checkKeyProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\cmdkey.exe");
	checkKeyProcess.StartInfo.Arguments = "/list TERMSRV/localhost";
	checkKeyProcess.StartInfo.UseShellExecute = false;
	checkKeyProcess.StartInfo.RedirectStandardOutput = true;
	checkKeyProcess.Start();
	checkKeyProcess.WaitForExit();
	
	if (checkKeyProcess.StandardOutput.ReadToEnd().Contains("User: " + username)) return true;
	else return false;
}

int StartRDC()
{
	Process rdcProcess = new Process();
	rdcProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\mstsc.exe");
	rdcProcess.StartInfo.Arguments = "/v " + "localhost";
	rdcProcess.Start();
		
	int pid = rdcProcess.Id;
	return pid;
}

void CleanCredentials()
{
	Process delKeyProcess = new Process();
	delKeyProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\cmdkey.exe");
	delKeyProcess.StartInfo.Arguments = "/delete:TERMSRV/localhost";
	delKeyProcess.Start();
}

void HideWindow(int pid)
{
	IntPtr toHidePtr = Process.GetProcessById(pid).MainWindowHandle;
	ShowWindow(toHidePtr, 0);
}

DataTable GetUsers()
{
	DataTable users = CreateUserTable();
	
	Process getUsersProcess = new Process();
	getUsersProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\cmd.exe");
	getUsersProcess.StartInfo.Arguments = "/c query user";
	getUsersProcess.StartInfo.UseShellExecute = false;
	getUsersProcess.StartInfo.RedirectStandardOutput = true;
	getUsersProcess.Start();
	getUsersProcess.WaitForExit();
	
	using (StringReader reader = new StringReader(getUsersProcess.StandardOutput.ReadToEnd()))
	{
		reader.ReadLine();
	
		while (reader.Peek() > 0)
		{
			string readText = reader.ReadLine();
			var groups = Regex.Match(readText,queryUserRegEx).Groups;
			
			DataRow user = users.NewRow();
			user["SessionID"] = Convert.ToInt32(groups["session"].Value);
			user["User"] = groups["username"].Value;
			user["State"] = groups["state"].Value;
			users.Rows.Add(user);
		}
	}
	
	return users;
}

int GetCurrentSessionID()
{
	int sessionID;
	
	Process getUsersProcess = new Process();
	getUsersProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\cmd.exe");
	getUsersProcess.StartInfo.Arguments = "/c query user %username%";
	getUsersProcess.StartInfo.UseShellExecute = false;
	getUsersProcess.StartInfo.RedirectStandardOutput = true;
	getUsersProcess.Start();
	getUsersProcess.WaitForExit();
	
	using (StringReader reader = new StringReader(getUsersProcess.StandardOutput.ReadToEnd()))
	{
		reader.ReadLine();
		string readText = reader.ReadLine();
		var groups = Regex.Match(readText,queryUserRegEx).Groups;
			
		sessionID = Convert.ToInt32(groups["session"].Value);
	}
	
	return sessionID;
}

DataTable CreateUserTable()
{
	DataTable userTable = new DataTable("UserDetails");

	DataColumn[] cols ={
		new DataColumn("User",typeof(String)),
		new DataColumn("SessionId",typeof(Int32)),
		new DataColumn("State",typeof(String)),
    };

	userTable.Columns.AddRange(cols);
	userTable.PrimaryKey = new DataColumn[] { userTable.Columns["SessionId"] };
	
	return userTable;
}

bool LogOffSession(string server, int sessionID)
{
	IntPtr serverHandle = IntPtr.Zero;
	serverHandle = WTSOpenServer(server);

	bool val = WTSLogoffSession(serverHandle, sessionID, false);
	
	WTSCloseServer(serverHandle);
	return val;
}]]></code>
  </stage>
  <stage stageid="b4a9b955-286e-44c0-a5a1-d09035539b6b" name="Clean Up" type="SubSheetInfo">
    <subsheetid>6925cf35-a8fb-41fd-a708-570a874ba7e4</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="67ba5bda-c1bc-4594-b389-7692e65ec34a" name="Start" type="Start">
    <subsheetid>6925cf35-a8fb-41fd-a708-570a874ba7e4</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>2e74de88-66dd-4c68-85ef-dbe6d7e6e2d0</onsuccess>
  </stage>
  <stage stageid="2e74de88-66dd-4c68-85ef-dbe6d7e6e2d0" name="End" type="End">
    <subsheetid>6925cf35-a8fb-41fd-a708-570a874ba7e4</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>90</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="c3c460f6-0abd-4ba0-b3b2-05917e30cbb9" name="Start RDP Session" type="SubSheetInfo">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>Initiates a Remote Desktop Connection on the local machine.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="b9638912-4630-4db6-b57f-365c247d94c4" name="End" type="End">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>135</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="number" name="Process ID" narrative="The Process ID for the Remote Desktop Connection" stage="PID" />
    </outputs>
  </stage>
  <stage stageid="e3751225-76b2-407a-a0c9-38092a6b8f0d" name="Note1" type="Note">
    <subsheetid>6925cf35-a8fb-41fd-a708-570a874ba7e4</subsheetid>
    <narrative>Clean Up Page

This is an optional page where you might choose to perform some finalisation (or "cleanup") tasks as your business object is closed down.

The cleanup action will be called automatically immediately after closing your business object at the end of a business process.

You will not be able to call this action from a business process, nor will it be called at any other time than before the disposal of the business object.</narrative>
    <displayx>-180</displayx>
    <displayy>60</displayy>
    <displaywidth>180</displaywidth>
    <displayheight>230</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="29322d42-01c3-457c-9191-55a1b5f2f063" name="Note2" type="Note">
    <narrative>Initialise Page

This is an optional page where you might choose to perform some initialisation tasks after your business object is loaded.

The initialise action will be called automatically immediately after loading your business object.

You will not be able to call this action from a business process, nor will it be called at any other time than after the creation of the object.</narrative>
    <displayx>-180</displayx>
    <displayy>60</displayy>
    <displaywidth>180</displaywidth>
    <displayheight>230</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="d6fa34d4-e5cc-41e0-a29e-4562bd8166cf" name="Start RDP Session" type="Code">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="text" name="username" expr="[Username]" />
      <input type="password" name="password" expr="[Password]" />
      <input type="number" name="delay" expr="[Delay]" />
      <input type="flag" name="wowredirect" expr="[WOW Redirection?]" />
    </inputs>
    <outputs>
      <output type="flag" name="success" stage="Success" />
      <output type="number" name="pid" stage="PID" />
    </outputs>
    <onsuccess>ab5ab9d7-817d-46fb-bdc3-32044ccd612e</onsuccess>
    <code><![CDATA[CreateCredential(username, password);
Thread.Sleep(200);

success = CheckCredential(username);

if (success)
{
	if (wowredirect)
	{
		IntPtr wow64Value = IntPtr.Zero;
		Wow64DisableWow64FsRedirection(ref wow64Value);
	}
	
	pid = StartRDC();
	
	if (wowredirect)
	{
		IntPtr wow64Value = IntPtr.Zero;
		Wow64EnableWow64FsRedirection(ref wow64Value);
	}
}
else pid = 0;

int milliseconds = (int)(delay*1000);
Thread.Sleep(milliseconds);

CleanCredentials();

if (pid > 0) HideWindow((int)pid);]]></code>
  </stage>
  <stage stageid="26a148e3-7747-4e50-b2d5-6e2c1af3451b" name="Start" type="Start">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="text" name="Username" narrative="The username to log in with" stage="Username" />
      <input type="password" name="Password" narrative="The password to log in with" stage="Password" />
      <input type="number" name="Delay" narrative="A delay (in seconds) between starting the Remote Desktop session and deleting the cached credentials. This can prevent the credentials being deleted before the remote session is able to use them. Default is 2 seconds." stage="Delay" />
      <input type="flag" name="Use WOW64 Redirection?" narrative="Defaults to False. This should be set to True when running on a 64-bit server operating system if WOW64 Redirection is not already in place on the server." stage="WOW Redirection?" />
    </inputs>
    <onsuccess>d6fa34d4-e5cc-41e0-a29e-4562bd8166cf</onsuccess>
  </stage>
  <stage stageid="25aa2259-ae59-4e5c-8174-5edeb8cb397f" name="Username" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>text</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="c9c31ba1-6659-43ce-a16b-76ce0c20387c" name="Password" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>0</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>password</datatype>
    <initialvalueenc>
    </initialvalueenc>
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="e92d685b-c8c5-4e93-9947-804f27ba1463" name="Delay" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue>2</initialvalue>
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="e304c05a-cc91-437a-825e-459473848388" name="Success" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>105</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>flag</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="ab5ab9d7-817d-46fb-bdc3-32044ccd612e" name="Started MSTSC?" type="Decision">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <decision expression="[Success]" />
    <ontrue>0c300ddb-8d71-4033-92d3-8ccc47180f76</ontrue>
    <onfalse>da9c7c91-15cb-4f33-a6b8-86d42ccfadfc</onfalse>
  </stage>
  <stage stageid="da9c7c91-15cb-4f33-a6b8-86d42ccfadfc" name="No Credentials" type="Exception">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>105</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <exception type="System Exception" detail="&quot;Failed to create cached credentials&quot;" />
  </stage>
  <stage stageid="4b44046e-ff7c-4126-8547-76b70649a52b" name="Log Off Current" type="SubSheetInfo">
    <subsheetid>89646c06-55db-4863-b113-7672c59dc6bf</subsheetid>
    <narrative>Sends a log off command in the current RDP Session. This should be run from inside the session to be logged off.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="6a514d7d-f918-45aa-a068-80c6626b4f9e" name="Start" type="Start">
    <subsheetid>89646c06-55db-4863-b113-7672c59dc6bf</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>136fd42a-23be-4435-93b0-db88975ca1b4</onsuccess>
  </stage>
  <stage stageid="bd7f4cf9-e4b7-40fe-9eb9-9eb6472b49c6" name="End" type="End">
    <subsheetid>89646c06-55db-4863-b113-7672c59dc6bf</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="136fd42a-23be-4435-93b0-db88975ca1b4" name="Log Off" type="Code">
    <subsheetid>89646c06-55db-4863-b113-7672c59dc6bf</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>bd7f4cf9-e4b7-40fe-9eb9-9eb6472b49c6</onsuccess>
    <code><![CDATA[// Define new Log Off process
Process logOffProcess = new Process();

// Use shutdown.exe to log off
logOffProcess.StartInfo.FileName = Environment.ExpandEnvironmentVariables(@"%SystemRoot%\system32\shutdown.exe");
logOffProcess.StartInfo.Arguments = "/l";
logOffProcess.Start();]]></code>
  </stage>
  <stage stageid="fe6c5d0a-ad49-4c66-b0c6-d1dacbb24254" name="PID" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>150</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue>0</initialvalue>
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="0c300ddb-8d71-4033-92d3-8ccc47180f76" name="Got PID?" type="Decision">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>75</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <decision expression="[PID] &gt; 0" />
    <ontrue>b9638912-4630-4db6-b57f-365c247d94c4</ontrue>
    <onfalse>ae4b19d0-3456-4b88-8a16-45b9a7c7ff94</onfalse>
  </stage>
  <stage stageid="ae4b19d0-3456-4b88-8a16-45b9a7c7ff94" name="No MSTSC Process" type="Exception">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>105</displayx>
    <displayy>75</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <exception type="System Exception" detail="&quot;No PID was returned, indicating that the Remote Desktop Connection failed to initialise&quot;" />
  </stage>
  <stage stageid="1204b73b-5816-4d92-b889-04cd9c54d7e7" name="Kill RDP Session" type="SubSheetInfo">
    <subsheetid>6f776231-7e10-407d-b84f-ccfda1f6a4c1</subsheetid>
    <narrative>Disconnects a specified Remote Desktop Connection Session. This should be executed on the host Runtime Resource, not the Runtime Resource to be terminated.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="54378535-4f96-4321-a30b-c0e8fb06290a" name="Start" type="Start">
    <subsheetid>6f776231-7e10-407d-b84f-ccfda1f6a4c1</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="number" name="Process ID" narrative="The Process ID of the RDP session to be terminated" stage="PID" />
    </inputs>
    <onsuccess>cf2204ba-f1df-4468-a48d-3468fa356a38</onsuccess>
  </stage>
  <stage stageid="6c249a4f-8318-464d-afeb-84470e865edc" name="End" type="End">
    <subsheetid>6f776231-7e10-407d-b84f-ccfda1f6a4c1</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="cf2204ba-f1df-4468-a48d-3468fa356a38" name="Kill PID" type="Code">
    <subsheetid>6f776231-7e10-407d-b84f-ccfda1f6a4c1</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="number" name="pid" expr="[PID]" />
    </inputs>
    <onsuccess>6c249a4f-8318-464d-afeb-84470e865edc</onsuccess>
    <code><![CDATA[Process martyr = Process.GetProcessById((int)(pid));
martyr.Kill();]]></code>
  </stage>
  <stage stageid="24242193-bafd-4fc0-b6bb-e02783523668" name="PID" type="Data">
    <subsheetid>6f776231-7e10-407d-b84f-ccfda1f6a4c1</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="544ae7a4-7f4d-4b41-be9f-ff97c4e0e5ff" name="WOW Redirection?" type="Data">
    <subsheetid>8f61dacb-0685-41de-915d-001befb4b1d0</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>60</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>flag</datatype>
    <initialvalue>False</initialvalue>
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="89b48355-324c-4eb0-9f81-010549c62588" name="Log Off User" type="SubSheetInfo">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <narrative>Logs off the user in a specified RDP Session.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="e7a3c591-d7a3-4e65-88e7-ba223a9424ae" name="Start" type="Start">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="number" name="Session ID" narrative="The session ID of the user to be logged off" stage="Session ID" />
    </inputs>
    <onsuccess>11c16823-605d-4a2a-92dd-d696e8d46f6e</onsuccess>
  </stage>
  <stage stageid="85d8c9d6-c6b4-401b-ba64-4d7207c191c2" name="End" type="End">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="flag" name="Success" narrative="Indicates whether the user was successfully logged out" stage="Success" />
    </outputs>
  </stage>
  <stage stageid="11c16823-605d-4a2a-92dd-d696e8d46f6e" name="Log Off User" type="Code">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="number" name="sessionid" expr="[Session ID]" />
    </inputs>
    <outputs>
      <output type="flag" name="success" stage="Success" />
    </outputs>
    <onsuccess>85d8c9d6-c6b4-401b-ba64-4d7207c191c2</onsuccess>
    <code><![CDATA[success = LogOffSession("localhost", (int)sessionid);]]></code>
  </stage>
  <stage stageid="aa6e46b7-d574-4b01-bc9f-f28f35935975" name="Get Logged In Users" type="SubSheetInfo">
    <subsheetid>af7ce39a-c800-4bc3-bcad-e4e9965c38c9</subsheetid>
    <narrative>Returns a collection containing all the users currently logged into this machine, with the session ID and current state of each.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="4d6716ad-8c02-4d0d-8e96-b978fce401b8" name="Start" type="Start">
    <subsheetid>af7ce39a-c800-4bc3-bcad-e4e9965c38c9</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>c067628a-5e98-4553-aa60-1d58b4d31b9a</onsuccess>
  </stage>
  <stage stageid="26b99768-1b92-4ec1-88ce-4a9b5b78d5ff" name="End" type="End">
    <subsheetid>af7ce39a-c800-4bc3-bcad-e4e9965c38c9</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="collection" name="Users" narrative="A collection containing all the users currently logged into this machine, with the session ID and current state of each" stage="Users" />
    </outputs>
  </stage>
  <stage stageid="c067628a-5e98-4553-aa60-1d58b4d31b9a" name="Get Logged In Users" type="Code">
    <subsheetid>af7ce39a-c800-4bc3-bcad-e4e9965c38c9</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="collection" name="results" stage="Users" />
    </outputs>
    <onsuccess>26b99768-1b92-4ec1-88ce-4a9b5b78d5ff</onsuccess>
    <code><![CDATA[results = GetUsers();]]></code>
  </stage>
  <stage stageid="d2506021-2fcc-447e-92be-3fdb4a49d7d5" name="Users" type="Collection">
    <subsheetid>af7ce39a-c800-4bc3-bcad-e4e9965c38c9</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>collection</datatype>
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="073a8087-514c-4bd3-89f7-a11df3fd7ff1" name="Session ID" type="Data">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="ae95b0c6-d953-408e-b7cb-bb5aee4fc9b5" name="Success" type="Data">
    <subsheetid>46504710-b6e6-4f80-826b-6c3e89cb51b2</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>15</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>flag</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="94e714ae-6aad-4d17-99fa-72bd2f894ce8" name="Get Current Session ID" type="SubSheetInfo">
    <subsheetid>3dfd8390-706e-4cb2-b733-7adf34137125</subsheetid>
    <narrative>Retrieves the session ID of the user context in which this action is executed.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="e1d3abbd-df90-45bd-b2a0-9c1cbf502b6b" name="Start" type="Start">
    <subsheetid>3dfd8390-706e-4cb2-b733-7adf34137125</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <onsuccess>1b3a8f42-55d2-4a27-b719-fd593dc213f1</onsuccess>
  </stage>
  <stage stageid="26426812-bc5d-4ff2-b6cf-18fedcfe782a" name="End" type="End">
    <subsheetid>3dfd8390-706e-4cb2-b733-7adf34137125</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="number" name="SessionID" narrative="The session ID of the user in whose context this action was executed" stage="SessionID" />
    </outputs>
  </stage>
  <stage stageid="1b3a8f42-55d2-4a27-b719-fd593dc213f1" name="Get Current Session ID" type="Code">
    <subsheetid>3dfd8390-706e-4cb2-b733-7adf34137125</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="number" name="sessionid" stage="SessionID" />
    </outputs>
    <onsuccess>26426812-bc5d-4ff2-b6cf-18fedcfe782a</onsuccess>
    <code><![CDATA[sessionid = GetCurrentSessionID();]]></code>
  </stage>
  <stage stageid="a8aa5978-9a9c-459d-8f7f-ede377fce0cb" name="SessionID" type="Data">
    <subsheetid>3dfd8390-706e-4cb2-b733-7adf34137125</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="33876f1e-a21a-480c-b2de-5b03aa7912d9" name="Launch With PID" type="SubSheetInfo">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <narrative>Launches an application and returns its PID. Parameters are optional.</narrative>
    <displayx>-195</displayx>
    <displayy>-105</displayy>
    <displaywidth>150</displaywidth>
    <displayheight>90</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
  </stage>
  <stage stageid="04f44753-ca3d-4230-8c60-c5dd6358d08b" name="Start" type="Start">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-105</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="text" name="Application" narrative="Full file path of the application launch file, e.g. C:\Program Files\internet explorer\iexplore.exe" stage="Application" />
      <input type="text" name="Application Parameters" narrative="(Optional) Any parameters you want to pass to the application as part of the launch e.g. https://www.blueprism.com/" stage="Application Parameters" />
    </inputs>
    <onsuccess>1189159d-37de-4d35-bfb2-b1eb81545926</onsuccess>
  </stage>
  <stage stageid="eb6d3370-7957-48a9-bfd5-f28d2be65b72" name="End" type="End">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>15</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <outputs>
      <output type="number" name="PID" narrative="The Process ID for the launched application" stage="PID" />
    </outputs>
  </stage>
  <stage stageid="ab729c03-5fe7-4de1-8812-aeaf87311327" name="Application" type="Data">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>-30</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>text</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="0380a51d-6d71-4de6-8e99-4d66d20753cf" name="Application Parameters" type="Data">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>0</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>text</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="bced6321-343d-4e7d-86d1-20c205806ba8" name="PID" type="Data">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <narrative>
    </narrative>
    <displayx>-195</displayx>
    <displayy>45</displayy>
    <displaywidth>90</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <datatype>number</datatype>
    <initialvalue />
    <private />
    <alwaysinit />
  </stage>
  <stage stageid="1189159d-37de-4d35-bfb2-b1eb81545926" name="Launch Application" type="Code">
    <subsheetid>c659182c-0795-4ab1-8a96-9f17507a2276</subsheetid>
    <loginhibit />
    <narrative>
    </narrative>
    <displayx>15</displayx>
    <displayy>-45</displayy>
    <displaywidth>60</displaywidth>
    <displayheight>30</displayheight>
    <font family="Segoe UI" size="10" style="Regular" color="000000" />
    <inputs>
      <input type="text" name="AppName" expr="[Application]" />
      <input type="text" name="AppParams" expr="[Application Parameters]" />
    </inputs>
    <outputs>
      <output type="number" name="PID" stage="PID" />
    </outputs>
    <onsuccess>eb6d3370-7957-48a9-bfd5-f28d2be65b72</onsuccess>
    <code><![CDATA[using (Process process = Process.Start(AppName, AppParams))
{
    process.WaitForInputIdle();
    PID = (process.Id);
}]]></code>
  </stage>
</process>